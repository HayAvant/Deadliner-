<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>Deadliner</title>
    
    <!-- PWA Manifest and Theme Color -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3b82f6">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; }
        .collapsible-content.expanded { max-height: 1000px; }
        .rotate-180 { transform: rotate(180deg); }
        .modal-backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 40; opacity: 0; transition: opacity 0.3s ease-in-out; }
        .modal-backdrop.show { display: block; opacity: 1; }
        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.95); z-index: 50; opacity: 0; transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; }
        .modal.show { display: block; opacity: 1; transform: translate(-50%, -50%) scale(1); }
        .calendar-day { min-height: 120px; }
        .disabled-btn { opacity: 0.5; cursor: not-allowed; }
        .color-dot { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: border-color 0.2s; }
        .color-dot.selected { border-color: #3b82f6; box-shadow: 0 0 0 2px #fff, 0 0 0 4px #3b82f6; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #09f; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900">Deadliner</h1>
            <p class="text-gray-600 mt-2">Meet every deadline, track every grade.</p>
        </header>

        <!-- Main Controls -->
        <div class="flex justify-center mb-6">
            <div class="bg-gray-200 rounded-lg p-1 flex">
                <button id="gradesViewBtn" class="px-6 py-2 rounded-md bg-white shadow font-semibold text-blue-600">Grades</button>
                <button id="calendarViewBtn" class="px-6 py-2 rounded-md text-gray-600 font-semibold">Calendar</button>
            </div>
        </div>
        
        <div class="max-w-4xl mx-auto mb-6 flex justify-center items-center gap-4">
            <button id="exportDataBtn" class="bg-white text-gray-700 px-4 py-2 rounded-lg font-semibold hover:bg-gray-50 shadow-sm border">Export Data</button>
            <button id="importDataBtn" class="bg-white text-gray-700 px-4 py-2 rounded-lg font-semibold hover:bg-gray-50 shadow-sm border">Import Data</button>
            <input type="file" id="importFile" class="hidden" accept=".json">
        </div>

        <!-- Grades View -->
        <div id="gradesView" class="max-w-4xl mx-auto">
            <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                <h2 class="text-2xl font-semibold mb-4">Add a New Class</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" id="newClassName" placeholder="e.g., Biology 101" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <div>
                        <div id="color-palette" class="flex items-center gap-2">
                           <!-- Color dots will be injected here -->
                        </div>
                    </div>
                </div>
                <button id="addClassBtn" class="mt-4 w-full bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors duration-300">Add Class</button>
            </div>
            <div id="classList" class="space-y-6"></div>
        </div>
       
        <!-- Calendar View -->
        <div id="calendarView" class="hidden">
             <div class="bg-white p-4 sm:p-6 rounded-xl shadow-md">
                <div class="flex justify-between items-center mb-4">
                    <button id="prevMonthBtn" class="p-2 rounded-full hover:bg-gray-200"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
                    <h2 id="calendarMonthYear" class="text-xl sm:text-2xl font-bold text-center"></h2>
                    <button id="nextMonthBtn" class="p-2 rounded-full hover:bg-gray-200"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></button>
                </div>
                <div class="grid grid-cols-7 gap-1 text-center font-semibold text-gray-500 text-sm mb-2">
                    <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                </div>
                <div id="calendarGrid" class="grid grid-cols-7 gap-2"></div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="modalBackdrop" class="modal-backdrop"></div>
    <div id="assignmentModal" class="modal bg-white p-6 rounded-xl shadow-lg w-11/12 max-w-md">
        <h2 class="text-2xl font-semibold mb-4" id="modalTitle">Add Assignment</h2>
        <input type="hidden" id="modalClassId">
        <input type="hidden" id="modalAssignmentId">
        <div id="modalClassSelectorContainer" class="hidden mb-4">
            <label for="modalClassSelector" class="block text-sm font-medium text-gray-700 mb-1">Class</label>
            <select id="modalClassSelector" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
        </div>
        <div>
            <label for="assignmentName" class="block text-sm font-medium text-gray-700 mb-1">Assignment Name</label>
            <input type="text" id="assignmentName" placeholder="e.g., Midterm Exam" class="w-full p-3 border border-gray-300 rounded-lg">
        </div>
        <div class="mt-4 grid grid-cols-2 gap-4">
            <div>
                <label for="assignmentScore" class="block text-sm font-medium text-gray-700 mb-1">Score</label>
                <input type="number" id="assignmentScore" placeholder="e.g., 25" min="0" class="w-full p-3 border border-gray-300 rounded-lg">
            </div>
            <div>
                <label for="assignmentWeight" class="block text-sm font-medium text-gray-700 mb-1">Out of (Weight)</label>
                <input type="number" id="assignmentWeight" placeholder="e.g., 30" min="0" class="w-full p-3 border border-gray-300 rounded-lg">
            </div>
        </div>
        <div class="mt-4">
             <label for="assignmentDueDate" class="block text-sm font-medium text-gray-700 mb-1">Due Date</label>
             <input type="date" id="assignmentDueDate" class="w-full p-3 border border-gray-300 rounded-lg">
        </div>
        <div class="mt-6 flex justify-end gap-4">
            <button id="cancelAssignmentBtn" class="bg-gray-200 text-gray-800 px-6 py-2 rounded-lg font-semibold hover:bg-gray-300">Cancel</button>
            <button id="saveAssignmentBtn" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-700">Save</button>
        </div>
    </div>
    <div id="aiAssistantModal" class="modal bg-white p-6 rounded-xl shadow-lg w-11/12 max-w-lg"></div>
    <div id="aiResultModal" class="modal bg-white p-6 rounded-xl shadow-lg w-11/12 max-w-lg"></div>

    <!-- Edit Class Modal -->
    <div id="editClassModal" class="modal bg-white p-6 rounded-xl shadow-lg w-11/12 max-w-md">
        <h2 class="text-2xl font-semibold mb-4">Edit Class</h2>
        <input type="hidden" id="editClassId">
        <div>
            <label for="editClassName" class="block text-sm font-medium text-gray-700 mb-1">Class Name</label>
            <input type="text" id="editClassName" class="w-full p-3 border border-gray-300 rounded-lg">
        </div>
        <div class="mt-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">Class Color</label>
            <div id="edit-color-palette" class="flex items-center gap-2"></div>
        </div>
        <div class="mt-6 flex justify-end gap-4">
            <button id="cancelEditClassBtn" class="bg-gray-200 text-gray-800 px-6 py-2 rounded-lg font-semibold hover:bg-gray-300">Cancel</button>
            <button id="saveEditClassBtn" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-700">Save</button>
        </div>
    </div>

    <script>
    // --- PWA Service Worker Registration ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js')
                .then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                })
                .catch(error => {
                    console.log('ServiceWorker registration failed: ', error);
                });
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        // --- STATE MANAGEMENT ---
        let classes = JSON.parse(localStorage.getItem('classes')) || [];
        let currentYear = 2025;
        let currentMonth = new Date().getFullYear() === 2025 ? new Date().getMonth() : 0;
        const colorPalette = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#3b82f6', '#8b5cf6', '#ec4899'];

        // --- DOM ELEMENTS ---
        const gradesViewBtn = document.getElementById('gradesViewBtn');
        const calendarViewBtn = document.getElementById('calendarViewBtn');
        const gradesView = document.getElementById('gradesView');
        const calendarView = document.getElementById('calendarView');
        const classList = document.getElementById('classList');
        const newClassNameInput = document.getElementById('newClassName');
        const addClassBtn = document.getElementById('addClassBtn');
        const colorPaletteContainer = document.getElementById('color-palette');
        const modalBackdrop = document.getElementById('modalBackdrop');
        const assignmentModal = document.getElementById('assignmentModal');
        const calendarGrid = document.getElementById('calendarGrid');
        const exportDataBtn = document.getElementById('exportDataBtn');
        const importDataBtn = document.getElementById('importDataBtn');
        const importFile = document.getElementById('importFile');
        const editClassModal = document.getElementById('editClassModal');
        
        // --- DATA & STATE HELPERS ---
        const saveData = () => localStorage.setItem('classes', JSON.stringify(classes));
        const calculateAverage = (assignments = []) => {
            const totalScore = assignments.reduce((sum, a) => sum + (a.score || 0), 0);
            const totalWeight = assignments.reduce((sum, a) => sum + (a.weight || 0), 0);
            if (totalWeight === 0) return 'N/A';
            return `${((totalScore / totalWeight) * 100).toFixed(2)}%`;
        };

        // --- RENDER FUNCTIONS ---
        const renderAll = () => {
            renderClasses();
            if (!calendarView.classList.contains('hidden')) renderCalendar();
        };

        const renderColorPalette = () => {
            colorPaletteContainer.innerHTML = '';
            colorPalette.forEach((color, index) => {
                const dot = document.createElement('div');
                dot.className = `color-dot ${index === 0 ? 'selected' : ''}`;
                dot.style.backgroundColor = color;
                dot.dataset.color = color;
                dot.addEventListener('click', () => {
                    colorPaletteContainer.querySelector('.selected').classList.remove('selected');
                    dot.classList.add('selected');
                });
                colorPaletteContainer.appendChild(dot);
            });
        };

        const renderEditColorPalette = () => {
            const editColorPaletteContainer = document.getElementById('edit-color-palette');
            editColorPaletteContainer.innerHTML = '';
            colorPalette.forEach((color) => {
                const dot = document.createElement('div');
                dot.className = `color-dot`;
                dot.style.backgroundColor = color;
                dot.dataset.color = color;
                dot.addEventListener('click', () => {
                    const currentSelected = editColorPaletteContainer.querySelector('.selected');
                    if (currentSelected) currentSelected.classList.remove('selected');
                    dot.classList.add('selected');
                });
                editColorPaletteContainer.appendChild(dot);
            });
        };
        
        const renderClasses = () => {
            classList.innerHTML = '';
            if (classes.length === 0) {
                classList.innerHTML = `<div class="text-center py-10 px-6 bg-white rounded-xl shadow-md"><h3 class="text-xl font-semibold text-gray-700">No classes yet!</h3><p class="text-gray-500 mt-2">Use the form above to add your first class.</p></div>`;
                return;
            }
            classes.forEach(cls => {
                const average = calculateAverage(cls.assignments);
                const card = document.createElement('div');
                card.className = 'course-card bg-white rounded-xl shadow-md overflow-hidden';
                card.style.borderLeft = `5px solid ${cls.color}`;
                card.innerHTML = `
                    <div class="p-4 flex justify-between items-center cursor-pointer class-header" data-id="${cls.id}">
                        <div>
                            <h3 class="text-2xl font-bold">${cls.name}</h3>
                            <p class="text-lg font-semibold text-gray-600">Grade: ${average}</p>
                        </div>
                        <div class="flex items-center gap-2">
                             <button class="edit-class-btn p-2 rounded-full hover:bg-gray-200 transition-colors" data-id="${cls.id}" title="Edit Class">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z" /></svg>
                            </button>
                            <button class="delete-class-btn p-2 rounded-full hover:bg-gray-200 transition-colors" data-id="${cls.id}" title="Delete Class">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>
                            <svg class="w-6 h-6 transition-transform chevron ${cls.isCollapsed ? '' : 'rotate-180'}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                    </div>
                    <div class="collapsible-content px-4 pb-4 ${cls.isCollapsed ? '' : 'expanded'}">
                        <div class="assignment-list space-y-2 border-t pt-4">
                            ${(cls.assignments || []).map(assign => {
                                const percentage = assign.weight > 0 ? ((assign.score / assign.weight) * 100).toFixed(2) : '0.00';
                                return `<div class="grid grid-cols-3 items-center p-2 rounded-md hover:bg-gray-50">
                                    <span>${assign.name}</span>
                                    <span class="text-center text-sm text-gray-500">${assign.dueDate || 'N/A'}</span>
                                    <div class="text-right flex justify-end items-center gap-2">
                                        <span>${(assign.score || 0).toFixed(2)}/${assign.weight} (${percentage}%)</span>
                                        <button class="edit-assignment-btn p-1 rounded-full hover:bg-gray-200 transition-colors" data-class-id="${cls.id}" data-assign-id="${assign.id}" title="Edit Assignment">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z" /></svg>
                                        </button>
                                        <button class="delete-assignment-btn p-1 rounded-full hover:bg-gray-200 transition-colors" data-class-id="${cls.id}" data-assign-id="${assign.id}" title="Delete Assignment">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                        </button>
                                    </div>
                                </div>`;
                            }).join('') || '<p class="text-gray-500 text-center py-2">No assignments yet.</p>'}
                        </div>
                        <div class="mt-4 flex gap-2">
                            <button class="add-assignment-btn w-full bg-gray-100 text-gray-700 px-4 py-2 rounded-lg font-semibold hover:bg-gray-200" data-id="${cls.id}">Add Assignment</button>
                        </div>
                    </div>
                `;
                classList.appendChild(card);
            });
            attachGradeViewListeners();
        };

        const renderCalendar = () => {
            const year = currentYear;
            const month = currentMonth;
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            document.getElementById('calendarMonthYear').textContent = `${new Date(year, month).toLocaleString('default', { month: 'long' })} ${year}`;
            calendarGrid.innerHTML = '';
            
            for (let i = 0; i < firstDay; i++) calendarGrid.innerHTML += '<div></div>';

            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayAssignments = classes.flatMap(c => (c.assignments || []).filter(a => a.dueDate === dateStr).map(a => ({...a, className: c.name, classColor: c.color})));
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day border border-gray-200 rounded-md p-1.5 flex flex-col relative';
                dayCell.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="font-semibold text-gray-700">${day}</span>
                        <button class="add-assignment-cal-btn text-gray-400 hover:text-blue-500" data-date="${dateStr}">+</button>
                    </div>
                    <div class="mt-1 space-y-1 overflow-hidden text-xs flex-grow day-assignments" data-expanded="false">
                        ${dayAssignments.length > 0 ? generateAssignmentsHTML(dayAssignments) : ''}
                    </div>
                `;
                if(dayAssignments.length > 2) {
                    dayCell.querySelector('.day-assignments').classList.add('cursor-pointer');
                    dayCell.querySelector('.day-assignments').addEventListener('click', (e) => {
                        const container = e.currentTarget;
                        const isExpanded = container.dataset.expanded === 'true';
                        container.dataset.expanded = !isExpanded;
                        container.innerHTML = generateAssignmentsHTML(dayAssignments, !isExpanded);
                    });
                }
                calendarGrid.appendChild(dayCell);
            }
        };

        const generateAssignmentsHTML = (assignments, collapsed = true) => {
            const limit = 2;
            const displayAssignments = (collapsed && assignments.length > limit) ? assignments.slice(0, limit) : assignments;
            let html = displayAssignments.map(a => `<div class="p-1 rounded" style="background-color:${a.classColor}33; border-left: 3px solid ${a.classColor};" title="${a.className}: ${a.name}">${a.name}</div>`).join('');
            if (collapsed && assignments.length > limit) {
                html += `<div class="p-1 text-center font-semibold text-blue-600">+${assignments.length - limit} more</div>`;
            }
            return html;
        };
        
        // --- EVENT HANDLERS & LOGIC ---
        const addClass = () => {
            const name = newClassNameInput.value.trim();
            const color = colorPaletteContainer.querySelector('.selected')?.dataset.color || colorPalette[0];
            if (!name) return;
            classes.push({ id: Date.now().toString(), name, color, assignments: [], isCollapsed: false });
            newClassNameInput.value = '';
            saveData();
            renderClasses();
        };

        const openAssignmentModal = (classId = null, assignmentId = null, date = null) => {
            const modalTitle = document.getElementById('modalTitle');
            const classSelectorContainer = document.getElementById('modalClassSelectorContainer');
            const classSelector = document.getElementById('modalClassSelector');
            const modalClassIdInput = document.getElementById('modalClassId');
            const modalAssignmentIdInput = document.getElementById('modalAssignmentId');
            
            document.getElementById('assignmentName').value = '';
            document.getElementById('assignmentScore').value = '';
            document.getElementById('assignmentWeight').value = '';
            document.getElementById('assignmentDueDate').value = date || '';
            modalAssignmentIdInput.value = '';

            if (assignmentId) { // EDIT MODE
                const cls = classes.find(c => c.id === classId);
                const assign = cls?.assignments.find(a => a.id === assignmentId);
                if (assign) {
                    modalTitle.textContent = `Edit Assignment for ${cls.name}`;
                    classSelectorContainer.classList.add('hidden');
                    document.getElementById('assignmentName').value = assign.name;
                    document.getElementById('assignmentScore').value = assign.score;
                    document.getElementById('assignmentWeight').value = assign.weight;
                    document.getElementById('assignmentDueDate').value = assign.dueDate;
                    modalClassIdInput.value = classId;
                    modalAssignmentIdInput.value = assignmentId;
                }
            } else if (classId) { // ADD MODE from Grades View
                classSelectorContainer.classList.add('hidden');
                modalClassIdInput.value = classId;
                const cls = classes.find(c => c.id === classId);
                modalTitle.textContent = `Add Assignment for ${cls.name}`;
            } else { // ADD MODE from Calendar View
                classSelectorContainer.classList.remove('hidden');
                classSelector.innerHTML = classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                modalClassIdInput.value = ''; 
                modalTitle.textContent = 'Add New Assignment';
            }
            
            modalBackdrop.classList.add('show');
            assignmentModal.classList.add('show');
        };

        const saveAssignment = () => {
            let classId = document.getElementById('modalClassId').value;
            const assignmentId = document.getElementById('modalAssignmentId').value;

            if (!classId) { // If adding from calendar, get from selector
                classId = document.getElementById('modalClassSelector').value;
            }
            const name = document.getElementById('assignmentName').value.trim();
            const score = parseFloat(document.getElementById('assignmentScore').value);
            const weight = parseFloat(document.getElementById('assignmentWeight').value);
            const dueDate = document.getElementById('assignmentDueDate').value;
            
            if (!classId || !name || isNaN(weight) || weight <= 0) return;
            
            const cls = classes.find(c => c.id === classId);
            if (cls) {
                if (assignmentId) { // We are editing
                    const assign = cls.assignments.find(a => a.id === assignmentId);
                    if (assign) {
                        assign.name = name;
                        assign.score = score || 0;
                        assign.weight = weight;
                        assign.dueDate = dueDate;
                    }
                } else { // We are adding
                    cls.assignments.push({ id: Date.now().toString(), name, score: score || 0, weight, dueDate });
                }
                saveData();
                renderAll();
                closeModal();
            }
        };

        const closeModal = () => {
            modalBackdrop.classList.remove('show');
            assignmentModal.classList.remove('show');
            editClassModal.classList.remove('show');
        };

        const openEditClassModal = (classId) => {
            const cls = classes.find(c => c.id === classId);
            if (!cls) return;

            document.getElementById('editClassId').value = classId;
            document.getElementById('editClassName').value = cls.name;

            const editColorPaletteContainer = document.getElementById('edit-color-palette');
            const currentSelected = editColorPaletteContainer.querySelector('.selected');
            if(currentSelected) currentSelected.classList.remove('selected');
            
            const newSelected = editColorPaletteContainer.querySelector(`[data-color="${cls.color}"]`);
            if (newSelected) newSelected.classList.add('selected');

            modalBackdrop.classList.add('show');
            editClassModal.classList.add('show');
        };

        const saveEditClass = () => {
            const classId = document.getElementById('editClassId').value;
            const newName = document.getElementById('editClassName').value.trim();
            const newColor = document.getElementById('edit-color-palette').querySelector('.selected')?.dataset.color;

            if (!newName || !newColor) return;
            
            const cls = classes.find(c => c.id === classId);
            if (cls) {
                cls.name = newName;
                cls.color = newColor;
                saveData();
                renderAll();
                closeModal();
            }
        };

        const exportData = () => {
            const dataStr = JSON.stringify(classes, null, 2);
            const dataBlob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `grades_backup_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        };
        
        const importData = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedClasses = JSON.parse(e.target.result);
                    if (Array.isArray(importedClasses)) {
                        classes = importedClasses;
                        saveData();
                        renderAll();
                    } else { throw new Error('Invalid format'); }
                } catch (error) {
                    alert('Error: Could not import data. File may be corrupt or in the wrong format.');
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset file input
        };

        // --- EVENT LISTENERS ---
        function attachGradeViewListeners() {
            document.querySelectorAll('.class-header').forEach(header => {
                header.addEventListener('click', (e) => {
                    if (e.target.closest('.delete-class-btn') || e.target.closest('.edit-class-btn')) return;
                    const classId = header.dataset.id;
                    const cls = classes.find(c => c.id === classId);
                    if (cls) {
                        cls.isCollapsed = !cls.isCollapsed;
                        saveData();
                        header.querySelector('.chevron').classList.toggle('rotate-180');
                        header.nextElementSibling.classList.toggle('expanded');
                    }
                });
            });

            document.querySelectorAll('.edit-class-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openEditClassModal(btn.dataset.id);
                });
            });

            document.querySelectorAll('.delete-class-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (confirm('Are you sure you want to delete this class and all its assignments?')) {
                        classes = classes.filter(c => c.id !== btn.dataset.id);
                        saveData();
                        renderClasses();
                    }
                });
            });

            document.querySelectorAll('.edit-assignment-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    openAssignmentModal(btn.dataset.classId, btn.dataset.assignId);
                });
            });

            document.querySelectorAll('.delete-assignment-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const cls = classes.find(c => c.id === btn.dataset.classId);
                    if (cls) {
                        cls.assignments = cls.assignments.filter(a => a.id !== btn.dataset.assignId);
                        saveData();
                        renderAll();
                    }
                });
            });
            document.querySelectorAll('.add-assignment-btn').forEach(btn => btn.addEventListener('click', () => openAssignmentModal(btn.dataset.id)));
        }

        gradesViewBtn.addEventListener('click', () => {
            gradesView.classList.remove('hidden');
            calendarView.classList.add('hidden');
            gradesViewBtn.classList.add('bg-white', 'shadow');
            calendarViewBtn.classList.remove('bg-white', 'shadow');
        });

        calendarViewBtn.addEventListener('click', () => {
            calendarView.classList.remove('hidden');
            gradesView.classList.add('hidden');
            calendarViewBtn.classList.add('bg-white', 'shadow');
            gradesViewBtn.classList.remove('bg-white', 'shadow');
            renderCalendar();
        });

        calendarGrid.addEventListener('click', (e) => {
            if (e.target.closest('.add-assignment-cal-btn')) {
                const btn = e.target.closest('.add-assignment-cal-btn');
                openAssignmentModal(null, null, btn.dataset.date);
            }
        });
        
        addClassBtn.addEventListener('click', addClass);
        document.getElementById('saveAssignmentBtn').addEventListener('click', saveAssignment);
        document.getElementById('cancelAssignmentBtn').addEventListener('click', closeModal);
        document.getElementById('saveEditClassBtn').addEventListener('click', saveEditClass);
        document.getElementById('cancelEditClassBtn').addEventListener('click', closeModal);
        modalBackdrop.addEventListener('click', closeModal);
        exportDataBtn.addEventListener('click', exportData);
        importDataBtn.addEventListener('click', () => importFile.click());
        importFile.addEventListener('change', importData);

        // --- INITIALIZATION ---
        renderColorPalette();
        renderEditColorPalette();
        renderAll();
    });
    </script>
</body>
</html>

